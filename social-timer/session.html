<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pomodoro Session</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
  <style> 
    * {
      box-sizing: border-box;
    }

    /* Theme Variables */
    :root {
      --accent-primary: #7C83FD;
      --accent-secondary: #96baff;
      --accent-gradient: linear-gradient(135deg, #7C83FD 0%, #96baff 100%);
      --pie-color: rgba(124, 131, 253, 0.25);
      --border-color: rgba(226, 232, 240, 0.6);
      --text-primary: #1e293b;
      --glass-bg: rgba(255, 255, 255, 0.1);
    }
    /* Theme: Red */
    [data-theme="red"] {
      --accent-primary: #BB2649;
      --accent-secondary: #d64570;
      --accent-gradient: linear-gradient(135deg, #BB2649 0%, #d64570 100%);
      --pie-color: rgba(187, 38, 73, 0.25);
    }
    /* Theme: Teal */
    [data-theme="teal"] {
      --accent-primary: #009473;
      --accent-secondary: #00b894;
      --accent-gradient: linear-gradient(135deg, #009473 0%, #00b894 100%);
      --pie-color: rgba(0, 148, 115, 0.25);
    }
    /* Theme: Yellow */
    [data-theme="yellow"] {
      --accent-primary: #F5DF4D;
      --accent-secondary: #f7e66e;
      --accent-gradient: linear-gradient(135deg, #F5DF4D 0%, #f7e66e 100%);
      --pie-color: rgba(245, 223, 77, 0.4);
    }

    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      color: #1e293b;
      line-height: 1.6;
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    /* Chatbot Section - timer에서 복사 */
    .chatbot-section {
      display: flex;
      flex-direction: column;
      height: 700px;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      border: 1px solid #EAF0FB;
      transition: all 0.3s ease;
    }
    
    .card-title {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--accent-gradient);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1.5rem;
      text-align: center;
      letter-spacing: -0.02em;
    }
    
    .usage-info {
      text-align: center;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(124, 131, 253, 0.1);
      border: 1px solid var(--accent-primary);
      border-radius: 15px;
      color: var(--accent-primary);
      font-size: 0.85rem;
      font-weight: 600;
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      min-height: 400px;
      border: 1px solid #EAF0FB;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    
    .message {
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 15px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.4;
    }
    
    .message.user {
      background: var(--accent-gradient);
      color: white;
      margin-left: auto;
      text-align: right;
      border-radius: 18px 18px 4px 18px; /* 사용자 메시지 꼬리 */
    }
    
    .message.bot {
      background: rgba(255, 255, 255, 0.9);
      color: #334155;
      border: 1px solid #EAF0FB;
      margin-right: auto;
    }

    .message + .message {
      margin-top: 0.5rem;
    }

    .message.user + .message.bot,
    .message.bot + .message.user {
      margin-top: 1rem; /* 화자 바뀔 때 간격 더 벌림 */
    }

    .message.system {
      background: rgba(255, 255, 255, 0.1);
      color: #94a3b8;
      text-align: center;
      font-style: italic;
      margin: 0.5rem auto;
      max-width: 90%;
    }
    
    .chat-input-container {
      display: flex;
      gap: 0.5rem;
    }
    
    #message-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #EAF0FB;
      border-radius: 20px;
      font-size: 0.9rem;
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      color: #334155;
      font-family: 'Inter', sans-serif;
    }
    
    #send-button {
      padding: 0.75rem 1.5rem;
      background: var(--accent-gradient);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }
    
    .loading {
      text-align: center;
      padding: 0.5rem;
    }
    
    .typing-indicator {
      display: inline-block;
    }
    
    .typing-indicator span {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-primary);
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }
    
    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }
    
    .rate-limit-warning {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 1rem;
      margin-top: 1rem;
      text-align: center;
      font-weight: 600;
    }
    
    /* Focus Blocks Section */
    .block-controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      align-items: center;
    }
    
    .block-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: 1px solid #EAF0FB;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.9);
      color: #334155;
      font-size: 0.9rem;
      outline: none;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .block-item {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #EAF0FB;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      transition: all 0.3s ease;
    }
    
    .block-item.unlabeled {
      opacity: 0.7;
      font-style: italic;
      border-style: dashed;
      cursor: pointer;
    }
    
    .block-time {
      font-size: 0.8rem;
      color: #64748b;
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }
    
    .block-label {
      font-weight: 600;
      color: #334155;
      font-family: 'Inter', sans-serif;
      font-size: 0.9rem;
    }

    /* Theme Selector */
    .theme-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12), 
                  0 2px 8px rgba(0,0,0,0.08);
      border-color: rgba(255,255,255,1);
    }
    
    .theme-btn.active {
      border-color: rgba(255,255,255,1);
      box-shadow: 0 0 0 3px rgba(var(--accent-primary), 0.2), 
                  0 4px 20px rgba(0,0,0,0.15);
      transform: scale(1.05);
    }


    .settings-bar {
      display: flex;
      flex-direction: row; /* column에서 row로 변경 */
      align-items: center;
      justify-content: center;
      gap: 3rem; /* 간격 늘림 */
      margin-top: 1.5rem; /* 마진 줄임 */
    }
    
    header {
      font-weight: 400;
      font-size: 1rem;
      padding: 1.5rem 2rem;
      text-align: center;
      background: linear-gradient(135deg, #F5F7FA 0%, #EAF0FB 100%);
      color: #22223B;
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(223, 207, 190, 0.3);
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    header:hover {
      background: linear-gradient(135deg, #EAF0FB 0%, #F5F7FA 100%);
      box-shadow: 0 4px 20px rgba(124, 131, 253, 0.07);
      transform: translateY(-1px);
    }

    .invitation-container {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .invitation-text {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #4a5568;
      font-weight: 500;
    }

    .session-name {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 600;
      margin: 0 0.25rem;
    }

    .copy-hint {
      font-size: 0.85rem;
      color: #6C757D;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }

    header:hover .copy-hint {
      opacity: 1;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--accent-primary);
      border-radius: 50%;
      animation: pulse-dot 2s infinite;
      margin-right: 0.5rem;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      align-items: start;
    }

    .section-title {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 1.35rem;
      font-weight: 600;
      text-transform: uppercase;
      text-align: center;
      letter-spacing: 0.5px;
      color: var(--accent-primary);
      margin-bottom: 1rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    
    .btn-primary {
      background: var(--accent-gradient);
      color: white;
    }

    
    /* Timer Section */
    .timer-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 3rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      border: 1px solid #EAF0FB;
    }
    
    #phaseLabel {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
      color: #6C757D;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Enhanced Timer Circle */
    .timer-circle {
      position: relative;
      margin-bottom: 2rem;
    }
    
    svg {
      background: transparent;
      filter: drop-shadow(0 8px 32px rgba(0, 0, 0, 0.12));
      transition: all 0.3s ease;
    }
    
    #timerText {
      font-size: 1.3rem;
      font-weight: 600;
      fill: #64748b;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.5px;
    }
    
    .controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 2rem;
    }
    
    .controls button,
    .controls select {
      padding: 0.75rem 1.5rem;
      font-size: 0.9rem;
      font-weight: 500;
      border-radius: 12px;
      border: 1px solid #EAF0FB;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      color: #475569;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
    }
    
    .controls button:hover:not(:disabled) {
      background: var(--accent-gradient);
      color: white;
      border-color: var(--accent-primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(var(--accent-primary), 0.3);
    }
    
    .controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Footer - Fixed styling */
    footer {
      margin-top: 3rem;
      padding: 2rem 1.5rem;
      background: rgba(245, 247, 250, 0.7);
      backdrop-filter: blur(10px);
      border-top: 1px solid #EAF0FB;
    }
    
    .footer-content {
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
      color: #6C757D;
      font-size: 0.9rem;
    }
    
    .footer-link {
      color: var(--accent-primary);
      font-weight: 600;
      text-decoration: none;
    }
    
    .footer-link:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    
    /* Ambient Sound */
    .ambient-section {
      text-align: center;
      margin-top: 1.5rem;
    }
    
    .ambient-section label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #64748b;
    }

    .ambient-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.75rem;
    }
    
    .ambient-btn {
      font-size: 1.8rem;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid transparent;
      background: rgba(255,255,255,0.9);
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    
    .ambient-btn:hover {
      background: rgba(255,255,255,1);
      border-color: var(--accent-secondary);
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 6px 16px rgba(var(--accent-primary), 0.12);
    }
    
    .ambient-btn.active {
      border-color: var(--accent-primary);
      background: rgba(var(--accent-primary), 0.1);
      backdrop-filter: blur(10px);
      transform: scale(1.05);
      box-shadow: 0 0 0 2px var(--accent-primary), 0 4px 12px rgba(var(--accent-primary), 0.2);
    }

    .loading-msg {
      font-size: 0.85rem;
      color: #94a3b8;
      margin-top: 0.75rem;
      transition: opacity 0.3s ease;
      opacity: 1;
      text-align: center;
    }
    
    .hidden {
      opacity: 0;
      visibility: hidden;
    }


    
    /* Dashboard Section */
    .dashboard-section {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    
    .public-dashboard {
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #ffffff;
      border: 1.5px solid #EAF0FB;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(124, 131, 253, 0.04);
      transition: box-shadow 0.3s ease;
    }

    .public-dashboard:hover {
      box-shadow: 0 12px 36px rgba(124, 131, 253, 0.08);
    }
    
    .dashboard-title {
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.5rem;
      color: #6C757D;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .vibe-card {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      margin-bottom: 0.75rem;
      border: 2px solid #EAF0FB; /* 일관된 border 두께 */
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      width: 100%;
      max-width: 400px;
      min-height: 3rem; /* 최소 높이 설정 */
      box-sizing: border-box;
    }
    
    
    .vibe-card:hover {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }
    
    .vibe-card strong {
      color: #1e293b;
      font-weight: 600;
    }

    .vibe-card[style*="border-color: var(--accent-primary)"] {
      background: rgba(var(--accent-primary), 0.08) !important;
      border-color: var(--accent-primary) !important;
      border-width: 2px !important;
    }
    
    /* Fixed Goal Input - consistent sizing */
    .goal-input-container {
      width: 100%;
      max-width: 400px;
      margin-top: 1rem;
      position: relative;
    }
    
    #editableGoal {
      width: 100%;
      min-height: 3rem; /* vibe-card와 동일한 최소 높이 */
      max-height: 6rem; /* 최대 높이 제한 */
      padding: 0.75rem 3rem 0.75rem 1rem; /* 오른쪽에 버튼 공간 확보 */
      border: 2px solid #EAF0FB; /* vibe-card와 동일한 border */
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8); /* vibe-card와 동일 */
      backdrop-filter: blur(10px);
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      color: #334155;
      resize: none;
      box-sizing: border-box;
      transition: all 0.3s ease;
      outline: none;
      overflow-y: auto;
      line-height: 1.5;
      display: flex;
      align-items: center; /* 세로 중앙 정렬 */
    }
    
    #editableGoal:focus {
      border-color: var(--accent-primary);
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 0 3px rgba(var(--accent-primary), 0.1);
    }
    
    #editableGoal[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: #94a3b8;
      font-style: italic;
      pointer-events: none;
    }
    
    /* Goal save button */
    #saveGoalBtn {
      position: absolute;
      top: 50%;
      right: 0.5rem;
      transform: translateY(-50%);
      width: 2rem;
      height: 2rem;
      font-size: 1rem;
      color: #94a3b8;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #e2e8f0;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s ease;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .goal-input-container:hover #saveGoalBtn,
    #editableGoal:focus + #saveGoalBtn {
      display: flex;
   }
    
    #saveGoalBtn:hover {
      background: rgba(var(--accent-primary), 0.1);
      color: var(--accent-primary);
      border-color: var(--accent-primary);
      transform: translateY(-50%) scale(1.05);
    }
    
    #saveGoalBtn.saved {
      color: #10b981;
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
    }

    .goal-input-container > div:first-child {
      font-size: 0.9rem;
      color: #64748b;
      text-align: center;
      margin-bottom: 0.75rem;
      font-weight: 500;
    }

    h2,
    .dashboard-title {
      color: var(--accent-primary);
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .block-item:not(.unlabeled) {
      border-left: 4px solid var(--accent-primary);
      background: rgba(var(--accent-primary), 0.02);
    }
    
    .block-item.unlabeled {
      border-left: 4px solid #e2e8f0;
    }

    /* Primary Button */
    .primary-btn {
      padding: 1rem 1.5rem;
      font-size: 1.06rem;
      font-weight: 600;
      border: none;
      border-radius: 11px;
      cursor: pointer;
      font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
      background: var(--accent-gradient);
      color: #fff;
      box-shadow: 0 4px 14px rgba(var(--accent-primary), 0.3);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      position: relative;
      overflow: hidden;
    }
    
    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(var(--accent-primary), 0.4);
    }
    
    .primary-btn:active {
      transform: translateY(0);
    }
    
    .primary-btn span {
      position: relative;
      z-index: 1;
    }

    /* Input Fields */ 
    input[type="text"] {
      width: 100%;
      padding: 1rem 1.25rem;
      border: 2px solid #EAF0FB;
      border-radius: 11px;
      font-size: 1.03rem;
      font-family: 'Inter', sans-serif;
      background: #F5F7FA;
      color: #22223B;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    input[type="text"]:focus {
      border-color: var(--accent-primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(var(--accent-primary), 0.2);
    }
    
    input[type="text"]::placeholder {
      color: #B3B8C3;
      font-style: italic;
    }
    
    /* Toast */
    #saveToast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--accent-gradient);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(var(--accent-primary), 0.3);
      z-index: 999;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(100%);
      opacity: 0;
    }
    
    #saveToast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    /* User Setup */
    #userSetup {
      text-align: center;
      padding: 3rem 2rem;
      max-width: 500px;
      margin: 2rem auto;
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(124, 131, 253, 0.07);
      border: 1.5px solid #EAF0FB;
    }
    
    #userSetup h2 {
      font-weight: 600;
      color: #334155;
      margin-bottom: 2rem;
      font-size: 1.5rem;
    }
    
    #nameInput {
      padding: 1rem 1.5rem;
      border: 2px solid #EAF0FB;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      width: 100%;
      max-width: 300px;
      margin-bottom: 2rem;
      background: rgba(255, 255, 255, 0.9);
      outline: none;
      transition: all 0.2s ease;
    }
    
    #nameInput:focus {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(var(--accent-primary), 0.1);
    }
    
    #emojiGrid {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    
    #emojiGrid span {
      font-size: 2rem;
      padding: 1rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #emojiGrid span:hover {
      background: rgba(var(--accent-primary), 0.1);
      border-color: var(--accent-primary);
      transform: scale(1.1);
    }
    
    #emojiGrid span.selected {
      background: rgba(var(--accent-primary), 0.1);
      border-color: var(--accent-primary);
      transform: scale(1.1);
    }

    /* Mobile adjustments for user setup */
    @media (max-width: 768px) {
      #userSetup {
        padding: 2rem 1.5rem;
        margin: 1rem auto;
        max-width: 90%;
      }

      #userSetup h2 {
        font-size: 1.25rem;
        margin-bottom: 1.5rem;
      }

      #nameInput {
        max-width: 100%;
        margin-bottom: 1.5rem;
      }

      #emojiGrid {
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      #emojiGrid span {
        font-size: 1.5rem;
        padding: 0.75rem;
      }
    

      @media (max-width: 768px) {
      .vibe-card,
      #editableGoal {
        max-width: 100%;
        min-height: 2.5rem;
      }
      
      #editableGoal {
        padding: 0.6rem 2.5rem 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
      
      #saveGoalBtn {
        width: 1.8rem;
        height: 1.8rem;
        right: 0.4rem;
        font-size: 0.9rem;
      }
    }

    /* Section Cards */
    .section {
      background: rgba(255,255,255,0.97);
      backdrop-filter: blur(16px);
      padding: 2.3rem 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(124, 131, 253, 0.07);
      border: 1.5px solid #EAF0FB;
      margin-bottom: 3rem;
      width: 100%;
      transition: box-shadow 0.2s;
    }
    .section:hover {
      box-shadow: 0 12px 36px rgba(124, 131, 253, 0.13);
    }

    .theme-dots {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: center;
    }
    
    .theme-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.4;
    }
    
    .theme-dot:hover {
      opacity: 0.8;
      transform: scale(1.2);
    }
    
    .theme-dot.active {
      opacity: 1;
      transform: scale(1.1);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
    }
    
    .theme-dot[data-theme="purple"] {
      background: #a5b4fc;
    }
    
    .theme-dot[data-theme="red"] {
      background: #fca5a5;
    }
    
    .theme-dot[data-theme="teal"] {
      background: #5eead4;
    }
    
    .theme-dot[data-theme="yellow"] {
      background: #fde047;
    }

      .circle-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 2px solid transparent;
        background: rgba(255,255,255,0.9);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      }
      
      .circle-btn:hover {
        transform: scale(1.1);
        border-color: var(--accent-primary);
      }
      
      .circle-btn.active {
        background: var(--accent-primary);
        color: white;
        border-color: var(--accent-primary);
      }

    
    /* Responsive Design */

    @media (max-width: 768px) {
      .settings-bar {
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .theme-btn {
        width: 32px;
        height: 32px;
      }
      
      .ambient-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
      }
    }
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
        gap: 2rem;
      }

      .focus-blocks-section,
      .chatbot-section {
        min-height: 500px; /* 최소 높이 설정 */
      }
      .chat-messages {
        min-height: 300px;
      }
    }

      .chatbot-section.glass-card {
        background: rgba(255, 255, 255, 0.8);
        border: 1.5px solid #EAF0FB;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(124, 131, 253, 0.04);
        transition: box-shadow 0.3s ease;
      }
      
      .chatbot-section.glass-card:hover {
        box-shadow: 0 12px 36px rgba(124, 131, 253, 0.08);
      }

      .focus-blocks-section {
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 16px;
        padding: 2rem;
        border: 1.5px solid #EAF0FB;
        box-shadow: 0 8px 32px rgba(124, 131, 253, 0.04);
      }
        
      .notes-section {
        grid-template-columns: 1fr;
      }

      .theme-inline-palette {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
        margin-top: 1rem;
      }
      
    /* Add better mobile responsiveness */
    @media (max-width: 480px) {
      .container {
        padding: 0.5rem;
        gap: 1rem;
      }
      
      .timer-circle svg {
        width: 200px;
        height: 200px;
      }
      
      .controls {
        flex-direction: column;
        gap: 0.5rem;
      }
    }


    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .timer-section,
      .public-dashboard,
      .note-card {
        padding: 1.5rem;
      }

      .focus-blocks-section,
      .chatbot-section {
        margin-bottom: 1.5rem;
      }
      
      .chatbot-section {
        height: 500px; /* 모바일에서 적당한 높이 */
      }
      
      #timerText {
        font-size: 2rem;
      }
      
      .controls {
        flex-direction: column;
        width: 100%;
      }
      
      .controls button,
      .controls select {
        width: 100%;
      }

      .theme-selector {
        top: 0.5rem;
        gap: 0.5rem;
        padding: 0.5rem;
      }

      .theme-btn {
        width: 14px;
        height: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Theme Selector -->

  <header id="sessionHeader" onclick="copyInviteLink()">
    <div class="invitation-container">
      <div class="pulse-dot"></div>
      <div class="invitation-text">
        <span class="session-name" id="sessionName">creative-work</span>
      </div>
      <div class="copy-hint">
        <span>Click to copy invite link</span>
      </div>
    </div>
  </header>
  
  <div id="userSetup" style="text-align: center; padding: 4rem 2rem; max-width: 500px; margin: 2rem auto; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06); border: 1px solid rgba(255, 255, 255, 0.8);">
    <h2 style="font-weight: 600; color: #334155; margin-bottom: 2rem;">Set your name & character 🧸</h2>
    <input type="text" id="nameInput" placeholder="Your name" style="padding: 1rem 1.5rem; border: 2px solid #EAF0FB; border-radius: 12px; font-size: 1rem; font-family: 'Inter', sans-serif; width: 100%; max-width: 300px; margin-bottom: 2rem; background: rgba(255, 255, 255, 0.9); outline: none; transition: all 0.2s ease;" />
    <div id="emojiGrid" style="display: flex; justify-content: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 2rem;"></div>
    <button onclick="submitUser()" class="primary-btn">
      <span>Let's Go 🚀</span>
    </button>
  </div>

  <audio src="assets/beep.wav" id="beep"></audio>
  
  
  <div id="mainApp">
    <!-- Social Board 헤더 추가 -->
    <div style="text-align: center; margin: 2rem 0 1rem 0;">
      <h2 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--accent-primary); margin-bottom: 0.5rem;">
        👥 Social Board
      </h2>
      <p style="font-size: 1rem; color: #64748b; margin-bottom: 2rem;">
        Shared with everyone in this session
      </p>
    </div>

    
    <div class="container">
      <!-- Timer Section -->
      <div class="timer-section">
          <div class="theme-dots">
            <button class="theme-dot active" data-theme="purple"></button>
            <button class="theme-dot" data-theme="red"></button>
            <button class="theme-dot" data-theme="teal"></button>
            <button class="theme-dot" data-theme="yellow"></button>
          </div>
          
          <div id="phaseLabel">Focus</div>
        <div class="timer-circle">
          <svg viewBox="0 0 100 100" width="280" height="280">
            <circle cx="50" cy="50" r="45" fill="none" stroke="var(--border-color)" stroke-width="1.5" opacity="0.3" />
            <path id="pie" fill="var(--pie-color)" transform="rotate(0,50,50)" />
            <text x="50" y="55" text-anchor="middle" font-size="14" fill="var(--text-primary)" id="timerText">25:00</text>
          </svg>
        </div>
        
        <div class="controls">
            <button onclick="startTimer()">Start</button>
            <button onclick="pauseTimer()">Pause</button>
            <button onclick="resetTimer()">Reset</button>
            <button onclick="finishTimer()" style="background: #f87171; color: white;">Finish</button>
            <select id="focusSelect" onchange="setFocusDuration(this.value)">
            <option value="1500">25 min</option>
            <option value="2700">45 min</option>
            <option value="5400">90 min</option>
          </select>
        </div>

        <div class="settings-bar">
          <!-- 🎧 Ambient Sound -->
          <div class="ambient-section">
            <label>🎧 Ambient Sound</label>
            <div class="ambient-buttons">
              <button class="ambient-btn" data-sound="Fire">🔥</button>
              <button class="ambient-btn" data-sound="Rain">🌧️</button>
              <button class="ambient-btn" data-sound="Ocean">🌊</button>
              <button class="ambient-btn" data-sound="Forest">🌲</button>
              <button class="ambient-btn" data-sound="Muted">🔇</button>
            </div>
            <div id="sound-loading-msg" class="loading-msg hidden">Loading sound...</div>
          </div>
        </div>


        <audio id="ambientPlayer" loop></audio>
      </div>
      
      
      <!-- Dashboard Section -->
      <div class="dashboard-section">
        <div class="public-dashboard">
          <div class="section-title">Today's Focus</div>
          <p style="font-size: 1.1rem; color: #64748b; text-align: center; margin-bottom: 1.5rem; line-height: 1.5;">Write down the main task you'll focus on today. See what others are working on and stay motivated together.</p>
          
          <div id="vibeBoard"></div>
          
          <div class="goal-input-container">
            <div style="font-size: 0.9rem; color: #64748b; text-align: center; margin-bottom: 0.75rem; font-weight: 500;">✏️ Update your focus goal:</div>
            <div id="editableGoal" contenteditable="true" data-placeholder="What's one meaningful task you'll focus on?"></div>
            <button id="saveGoalBtn">✓</button>
          </div>
        </div>
      </div>

      <!-- Private Board Header -->
      <div style="grid-column: 1 / -1; text-align: center; margin: 3rem 0 1rem 0;">
        <h2 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.8rem; font-weight: 700; color: var(--accent-primary); margin-bottom: 0.5rem;">
          🔒 Private Board
        </h2>
        <p style="font-size: 1rem; color: #64748b; margin-bottom: 2rem;">
          Only visible to you - not shared with others
        </p>
      </div>

      <!-- Focus Blocks Section -->
      <div class="focus-blocks-section">
        <div class="section-title">⚡ Focus Sessions</div>
          <p style="font-size: 0.9rem; color: #94a3b8; text-align: center; margin-bottom: 1rem; font-style: italic;">
            Track what you accomplished in each session
          </p>
        <div class="block-controls">
          <input type="text" class="block-input" id="taskInput" placeholder="What did you accomplish?">
          <button class="btn btn-primary" onclick="labelLastBlock()">Save</button>
        </div>
        <div id="logList"></div>
      </div>

      <!-- Chatbot Section -->
      <div class="glass-card chatbot-section">
        <div class="card-title">💡 AI Motivation Partner</div>
        <p style="font-size: 0.9rem; color: #94a3b8; text-align: center; margin-bottom: 1rem; font-style: italic;">
          Declutter blockers. Conversation history is not saved.
        </p>
   
        <div class="usage-info">
          <small>💬 Usage: <span id="usage-count">0</span>/30 messages today</small>
        </div>
  
        <div id="chat-messages" class="chat-messages">
        </div>
  
        <div class="chat-input-container">
          <input type="text" id="message-input" placeholder="Tell me what's blocking you...">
          <button id="send-button">Send</button>
        </div>
  
        <div id="loading" class="loading hidden">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
  
        <div id="rate-limit-warning" class="rate-limit-warning hidden">
          <p>⚠️ You've reached the daily message limit (30 messages). Please try again tomorrow!</p>
          <small>This helps manage server costs. Thank you for understanding! 💝</small>
        </div>
      </div>
    </div>

      
    </div>
    
    <div id="saveToast">Saved ✔️</div>
  </div>

  <footer>
    <div class="footer-content">
      <div>
        Built by 
        <a href="https://inyoungcheong.github.io" class="footer-link" target="_blank">Inyoung Cheong</a>
      </div>
      <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.5rem;">
        Helping you stay focused and connected
      </div>
    </div>
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Chatbot variables
    let conversationId = null;
    const apiUrl = 'https://working-chatbot-api-production.up.railway.app/api/chat';
    const maxMessages = 30;
    const usageKey = 'dailyPlanner_usage_' + getTodayKey();
    const openingMessages = [
      "What's calling for your attention today? ✨",
      "How are you feeling about today's possibilities? 🌟",
      "What's one thing you're looking forward to tackling? 🎯",
      "What's been stirring in your mind this morning? 💭",
      "How would you like this day to unfold? 🌈",
      "What feels most important to focus on right now? ⚡",
      "What's awakening your creative energy today? 🚀",
      "How are you hoping to spend your time today? ⏰",
      "What would make today feel meaningful for you? 💫",
      "What thoughts are pulling at you today? 🧠"
    ];
    
    let sessionLog = [];
    
    function getRandomOpeningMessage() {
      return openingMessages[Math.floor(Math.random() * openingMessages.length)];
    }


    
    const firebaseConfig = {
      apiKey: "AIzaSyAW3sw__h-YyGOBowZULt2iZ59CP8KkU34",
      authDomain: "social-timer-a2315.firebaseapp.com",
      projectId: "social-timer-a2315",
      storageBucket: "social-timer-a2315.appspot.com",
      messagingSenderId: "68840014890",
      appId: "1:68840014890:web:ac1b634ab00b41622eef53"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  
    const session = new URLSearchParams(window.location.search).get("session");
    document.getElementById("sessionName").textContent = session || "focus-room";
    
    // Theme functions
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('pomodoro-theme', theme);
      
      // theme-btn 업데이트 (기존)
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const themeBtn = document.querySelector(`.theme-btn[data-theme="${theme}"]`);
      if (themeBtn) themeBtn.classList.add('active');
      
      // theme-dot 업데이트 (새로 추가)
      document.querySelectorAll('.theme-dot').forEach(btn => {
        btn.classList.remove('active');
      });
      const themeDot = document.querySelector(`.theme-dot[data-theme="${theme}"]`);
      if (themeDot) themeDot.classList.add('active');
    }
      
      
      
    function loadTheme() {
      const savedTheme = localStorage.getItem('pomodoro-theme') || 'purple';
      setTheme(savedTheme);
      }
    
    // Copy invite link function
    function copyInviteLink() {
      const inviteUrl = window.location.href;
      navigator.clipboard.writeText(inviteUrl).then(() => {
        // Show success feedback
        const header = document.getElementById("sessionHeader");
        const originalHTML = header.innerHTML;
        
        header.innerHTML = `
          <div class="invitation-container">
            <div style="color: #10b981; font-weight: 500;">
              ✓ Invite link copied to clipboard!
            </div>
          </div>
        `;
        
        setTimeout(() => {
          header.innerHTML = originalHTML;
        }, 2000);
      }).catch(() => {
        // Fallback for browsers that don't support clipboard API
        alert('Copy this link to invite others:\n' + window.location.href);
      });
    }
  
    const nameKey = `vibeUserName-${session}`;
    const emojiKey = `vibeUserAnimal-${session}`;
    const roleKey = `vibeUserRole-${session}`;
  
    let name = localStorage.getItem(nameKey);
    let emoji = localStorage.getItem(emojiKey);
    let role = localStorage.getItem(roleKey);
  
    const controls = document.querySelector(".controls");
  
    let selectedEmoji = "🐢";
    const emojis = ["🐢", "🦊", "🐰", "🐸", "🐼", "🐶", "🦁", "🐻", "🐨", "🐱"];

    function showSaveToast() {
      const toast = document.getElementById("saveToast");
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 2000);
    }

    function showErrorMessage(message) {
      alert(message); // Simple fallback
    }
    
    function showErrorToast(message) {
      console.error(message);
      // Could show a toast notification
    }
  
    function renderAvatarGrid() {
      const grid = document.getElementById("emojiGrid");
      grid.innerHTML = "";
      emojis.forEach((emoji) => {
        const span = document.createElement("span");
        span.textContent = emoji;
        span.style.cursor = "pointer";
        span.style.fontSize = "2rem";
        span.style.padding = "1rem";
        span.style.borderRadius = "12px";
        span.style.background = "rgba(255, 255, 255, 0.8)";
        span.style.border = "2px solid transparent";
        span.style.transition = "all 0.2s ease";
        span.onclick = () => {
          selectedEmoji = emoji;
          [...grid.children].forEach(el => {
            el.style.background = "rgba(255, 255, 255, 0.8)";
            el.style.borderColor = "transparent";
            el.style.transform = "scale(1)";
          });
          span.style.background = "rgba(99, 102, 241, 0.1)";
          span.style.borderColor = "#6366f1";
          span.style.transform = "scale(1.1)";
        };
        grid.appendChild(span);
      });
    }
  
    function submitUser() {
      const input = document.getElementById("nameInput");
      const userName = input.value.trim();
    // Better validation
      if (!userName) {
        showErrorMessage("Please enter your name.");
        return;
      }
      
      if (userName.length > 50) {
        showErrorMessage("Name must be less than 50 characters.");
        return;
      }
      
      // Sanitize input
      const sanitizedName = userName.replace(/[<>]/g, '');

    
      name = userName;
      emoji = selectedEmoji;
      role = localStorage.getItem(roleKey) || "guest";
    
      localStorage.setItem(nameKey, name);
      localStorage.setItem(emojiKey, emoji);
      localStorage.setItem(roleKey, role);
      
      db.collection("sessions").doc(session).collection("participants").doc(name).set({
        name,
        emoji,
        goal: "",
        timestamp: Date.now()
      });
    
      // 페이지 맨 위로 스크롤
      window.scrollTo(0, 0);
      
      document.getElementById("userSetup").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
    }

    // Pie chart drawing functions
    const pie = document.getElementById("pie");
    
    function polarToCartesian(cx, cy, r, angle) {
      const rad = (angle - 90) * Math.PI / 180;
      return [cx + r * Math.cos(rad), cy + r * Math.sin(rad)];
    }

    function drawPie(percent) {
      const [cx, cy, r] = [50, 50, 45];
      const angle = percent * 360;
      const [x, y] = polarToCartesian(cx, cy, r, angle);
      const largeArc = angle > 180 ? 1 : 0;
      const d = `
        M ${cx} ${cy}
        L ${cx} ${cy - r}
        A ${r} ${r} 0 ${largeArc} 1 ${x} ${y}
        Z
      `;
      pie.setAttribute("d", d);
    }

    function updateProgress() {
      const ratio = localSeconds / duration;
      const progress = 1 - ratio;
      drawPie(progress);
    
      const m = String(Math.floor(localSeconds / 60)).padStart(2, '0');
      const s = String(localSeconds % 60).padStart(2, '0');
      document.getElementById('timerText').textContent = `${m}:${s}`;
    }

    window.onload = () => {
      loadTheme();
      displayTime(localSeconds);
      
      // 테마 이벤트 리스너 추가
      document.querySelectorAll('.theme-dot').forEach(btn => {
        btn.addEventListener('click', () => {
          const theme = btn.getAttribute('data-theme');
          if (theme) {
            setTheme(theme);
          }
        });
      });
      
      if (name && emoji) {
        // 사용자가 이미 설정되어 있으면 맨 위에서 시작
        window.scrollTo(0, 0);
        document.getElementById("userSetup").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
    
        db.collection("sessions").doc(session).collection("participants").doc(name).set({
          name,
          emoji,
          goal: "",
          timestamp: Date.now()
        });
      } else {
        renderAvatarGrid();
        document.getElementById("userSetup").style.display = "block";
        document.getElementById("mainApp").style.display = "none";
      }
    
      if (localStorage.getItem(roleKey) !== "host") {
        controls.querySelectorAll("button").forEach(btn => {
          if (btn.onclick && btn.onclick.toString().includes('finishTimer')) {
            // Hide finish button for guests
            btn.style.display = 'none';
          } else {
            btn.disabled = true;
          }
        });
      
        const select = document.getElementById("focusSelect");
        if (select) {
          select.disabled = true;
        }
        const focusSelect = document.getElementById("focusSelect");
        if (focusSelect) {
          setFocusDuration(focusSelect.value);
        }
      
        // Add leave button for guests
        const leaveBtn = document.createElement("button");
        leaveBtn.textContent = "Leave Session";
        leaveBtn.style.background = "#6b7280";
        leaveBtn.style.color = "white";
        leaveBtn.onclick = () => {
          if (confirm("Are you sure you want to leave this session?")) {
            window.close();
          }
        };
        controls.appendChild(leaveBtn);
      
        const notice = document.createElement("div");
        notice.innerHTML = `<div style="font-size: 0.85rem; color: #64748b; background: rgba(248, 250, 252, 0.8); border: 1px solid #EAF0FB; border-radius: 8px; padding: 0.75rem; margin-top: 1rem; text-align: center;"><strong>Only the host</strong> can control the timer.</div>`;
        controls.appendChild(notice);
      }
              
      updatePhaseLabel(); 
      updateUsageDisplay();
      setupChatEventListeners();
      loadBlocks();
      
      if (!isRateLimited()) {
        enableChatInput();
      } else {
        showRateLimit();
      }
    
      const initialMessage = getRandomOpeningMessage();
      addMessage(initialMessage, 'bot');
    }; 

    // Organize code into modules
      const TimerManager = {
        init() { /* timer initialization */ },
        start() { /* start timer */ },
        pause() { /* pause timer */ },
        reset() { /* reset timer */ }
      };
      
      const ChatManager = {
        init() { /* chat initialization */ },
        sendMessage() { /* send message */ },
        handleResponse() { /* handle response */ }
      };

    
    let focusDuration = 1500;
    let phaseIndex = 0;
    let localSeconds = focusDuration;
    let duration = focusDuration;
    let isRunning = false;
    let localTimer = null;
    let timerStartTime = null; // Track when timer actually started
    
    const beep = document.getElementById("beep");
    
    function getPhases(focus) {
      return [
        { label: "Focus", duration: focus },
        { label: "Break", duration: 300 },
        { label: "Focus", duration: focus },
        { label: "Break", duration: 300 },
        { label: "Focus", duration: focus },
        { label: "Break", duration: 300 },
        { label: "Focus", duration: focus },
        { label: "Long Break", duration: 1200 }
      ];
    }
    
    let phases = getPhases(focusDuration);
    
    const timerText = document.getElementById("timerText");
    
    function displayTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, "0");
      const s = String(sec % 60).padStart(2, "0");
      timerText.textContent = `${m}:${s}`;
      updateProgress();
    }
    
    function startLocalTimer() {
      stopLocalTimer();
      timerStartTime = Date.now();
      localTimer = setInterval(() => {
        // Calculate elapsed time since start to stay in sync
        const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
        localSeconds = Math.max(0, duration - elapsed);
        
        updateProgress();
        if (localSeconds <= 0) {
          beep.play();
          nextPhase();
        }
      }, 1000); // Update more frequently for smoother display
    }
    
    function stopLocalTimer() {
      if (localTimer) clearInterval(localTimer);
      localTimer = null;
    }
    
    function pauseTimer() {
      updateRemoteTimer({
        isRunning: false,
        remainingSeconds: localSeconds,
        lastUpdated: Date.now(),
        phaseIndex: phaseIndex,
        duration: duration
      });
    }
    
    function resetTimer() {
      localSeconds = duration;
      updateRemoteTimer({
        isRunning: false,
        remainingSeconds: localSeconds,
        lastUpdated: Date.now(),
        phaseIndex: phaseIndex,
        duration: duration
      });
      displayTime(localSeconds);
    }
    
    function setFocusDuration(sec) {
      focusDuration = parseInt(sec);
      phases = getPhases(focusDuration);
      phaseIndex = 0;
    
      localSeconds = phases[phaseIndex].duration;
      duration = localSeconds;
      displayTime(localSeconds);
      updatePhaseLabel(); 
    }
    
    function updateRemoteTimer(state) {
      db.collection("sessions").doc(session).collection("state").doc("timer").set(state);
    }
    
    function startTimer() {
      updatePhaseLabel();
      timerStartTime = Date.now();
      duration = localSeconds; // Set duration to current remaining time
      updateRemoteTimer({
        isRunning: true,
        remainingSeconds: localSeconds,
        lastUpdated: Date.now(),
        phaseIndex: phaseIndex,
        duration: duration
      });
    }
    
        function finishTimer() {
          // Show confirmation dialog for host
          if (!confirm("Are you sure you want to finish this timer session for everyone?\n\nThis will end the session for all participants.\n\nClick OK to finish\nClick Cancel to continue")) {
            return; // Host clicked Cancel - go back to timer
          }
          
          updateRemoteTimer({
            isRunning: false,
            remainingSeconds: 0,
            lastUpdated: Date.now(),
            phaseIndex: phaseIndex,
            duration: duration,
            finished: true
          });
          
          // Show completion message
          const phaseLabel = document.getElementById("phaseLabel");
          phaseLabel.textContent = "Session Complete! 🎉";
          phaseLabel.style.color = "#10b981";
        }
        
        db.collection("sessions").doc(session).collection("state").doc("timer")
          .onSnapshot(doc => {
            const data = doc.data();
            if (!data) return;
            
            console.log("Timer sync data:", data); // Debug log
            
        // Sync phase if different
        if (data.phaseIndex !== undefined && data.phaseIndex !== phaseIndex) {
          phaseIndex = data.phaseIndex;
          updatePhaseLabel();
        }
        
        // Always use the server data as source of truth
        if (data.isRunning && data.lastUpdated) {
          const now = Date.now();
          const elapsed = Math.floor((now - data.lastUpdated) / 1000);
          localSeconds = Math.max(0, data.remainingSeconds - elapsed);
          duration = data.duration || data.remainingSeconds;
          timerStartTime = now - (elapsed * 1000);
        } else {
          localSeconds = data.remainingSeconds || 0;
          duration = data.duration || localSeconds;
          timerStartTime = null;
        }
        
        isRunning = data.isRunning || false;
        
        // Handle finish state
        if (data.finished) {
          localSeconds = 0;
          isRunning = false;
          stopLocalTimer();
          const phaseLabel = document.getElementById("phaseLabel");
          phaseLabel.textContent = "Session Complete! 🎉";
          phaseLabel.style.color = "#10b981";
        }
        
        displayTime(localSeconds);
        if (isRunning && localSeconds > 0) {
          startLocalTimer();
        } else {
          stopLocalTimer();
        }
      });

    db.collection("sessions").doc(session).collection("participants")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        const board = document.getElementById("vibeBoard");
        board.innerHTML = "";
    
        snapshot.forEach(doc => {
          const p = doc.data();
          const goal = p.goal || "";
          const participantName = p.name || "Anonymous";
          const emoji = p.emoji || "🐾";
    
          const div = document.createElement("div");
          div.className = "vibe-card";
          
          // Add special styling for your own goal
          if (participantName === name) {
            div.style.background = "rgba(var(--accent-primary), 0.08)";
            div.style.borderColor = "var(--accent-primary)";
            div.style.borderWidth = "2px";
          }
          
          const nameSpan = document.createElement("strong");
          nameSpan.textContent = participantName;
          if (p.role === "host") {
            nameSpan.innerHTML += ' 👑';
          }
          // Add "You" indicator for your own goal
          if (participantName === name) {
            nameSpan.innerHTML += ' (You)';
          }
    
          const goalSpan = document.createElement("span");
          goalSpan.innerText = goal || "Setting up their focus goal...";
          goalSpan.style.color = goal ? "#475569" : "#94a3b8";
          goalSpan.style.fontStyle = goal ? "normal" : "italic";
    
          div.appendChild(document.createTextNode(emoji + " "));
          div.appendChild(nameSpan);
          div.appendChild(document.createTextNode(" "));
          div.appendChild(goalSpan);
    
          board.appendChild(div);
        });
      });

    function updatePhaseLabel() {
      document.getElementById("phaseLabel").textContent = phases[phaseIndex].label;
    }
    
    function nextPhase() {
        if (phases[phaseIndex].label === "Focus") {
        const endTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        sessionLog.push({
          text: '',
          duration: `${focusDuration / 60} min`,
          time: endTime,
          type: 'focus',
          label: ''
        });
        saveBlocks();
        loadBlocks();
      }
      
      phaseIndex = (phaseIndex + 1) % phases.length;
      const phase = phases[phaseIndex];
      localSeconds = phase.duration;
      duration = phase.duration;
    
      updatePhaseLabel();
      updateRemoteTimer({
        isRunning: true,
        remainingSeconds: localSeconds,
        lastUpdated: Date.now(), 
        phaseIndex: phaseIndex, 
        duration: duration
      });
    }

        // Chatbot functions
    function getTodayKey() {
      const today = new Date();
      return today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
    }

    function getUsageCount() {
      const stored = localStorage.getItem(usageKey);
      return stored ? parseInt(stored) : 0;
    }

    function incrementUsage() {
      const current = getUsageCount();
      localStorage.setItem(usageKey, (current + 1).toString());
      updateUsageDisplay();
    }

    function updateUsageDisplay() {
      const usage = getUsageCount();
      document.getElementById('usage-count').textContent = usage;
      
      if (usage >= maxMessages) {
        showRateLimit();
      }
    }

    function showRateLimit() {
      disableChatInput();
      document.getElementById('rate-limit-warning').classList.remove('hidden');
      addMessage('You\'ve reached today\'s message limit. See you tomorrow! 🌅', 'system');
    }

    function isRateLimited() {
      return getUsageCount() >= maxMessages;
    }

    function setupChatEventListeners() {
      document.getElementById('send-button').addEventListener('click', () => sendMessage());
      document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    async function sendMessage() {
      if (isRateLimited()) {
        showRateLimit();
        return;
      }

      const message = document.getElementById('message-input').value.trim();
      if (!message) return;

      addMessage(message, 'user');
      document.getElementById('message-input').value = '';
      disableChatInput();

      incrementUsage();

      try {
        const response = await callAPI(message);
        addMessage(response.message, 'bot');
        
        if (response.conversationId) {
          conversationId = response.conversationId;
        }
      } catch (error) {
        addMessage('Sorry, I encountered an error. Please try again later.', 'bot');
        console.error('Error:', error);
      } finally {
        if (!isRateLimited()) {
          enableChatInput();
        }
      }
    }

    async function callAPI(message) {
      showLoading();
      
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message,
            conversationId: conversationId
          })
        });

        hideLoading();

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        hideLoading();
        throw error;
      }
    }

    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      messageDiv.textContent = text;
      
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function enableChatInput() {
      if (!isRateLimited()) {
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-button').disabled = false;
      }
    }

    function disableChatInput() {
      document.getElementById('message-input').disabled = true;
      document.getElementById('send-button').disabled = true;
    }

    // Add loading indicators for async operations
    function showLoading(message = "Loading...") {
      const loader = document.createElement('div');
      loader.className = 'loading-overlay';
      loader.innerHTML = `<div class="spinner">${message}</div>`;
      document.body.appendChild(loader);
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

  

    const ambientPlayer = document.getElementById("ambientPlayer");
    const ambientMap = {
      fire: "https://archive.org/download/relaxingsounds/FIRE%202%203h%20Blazing%20Fireplace.mp3",
      rain: "https://archive.org/download/relaxingsounds/Rain%207%20%28Lightest%29%208h%20DripsOnTrees-no%20thunder.mp3",
      wind: "https://archive.org/download/relaxingsounds/Wind%201%208h%20%28or%20Rapids%29%20Gentle%2CLowPitch%2CBrownNoise.mp3",
      forest: "https://archive.org/download/relaxingsounds/Snowfall%20%26%20Wind%28Lite%29%2010h%20Dusk%20into%20Night-Forest.mp3"
    };
    
    function setAmbient(type, el) {
      const url = ambientMap[type];
      const player = document.getElementById("ambientPlayer");
    
      if (url) {
        player.src = url;
        player.play();
      } else {
        player.pause();
        player.src = "";
      }
    
      // Update active state
      document.querySelectorAll(".ambient-btn").forEach(btn => btn.classList.remove("active"));
      if (el) el.classList.add("active");
    }

    
      const ambientButtons = document.querySelectorAll('.ambient-btn[data-sound]');
      const loadingMsg = document.getElementById('sound-loading-msg');
    
      ambientButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const soundName = btn.getAttribute('data-sound');
          
          // Set ambient sound
          if (soundName === 'Fire') {
            setAmbient('fire', btn);
          } else if (soundName === 'Rain') {
            setAmbient('rain', btn);
          } else if (soundName === 'Ocean') {
            setAmbient('wind', btn);
          } else if (soundName === 'Forest') {
            setAmbient('forest', btn);
          } else if (soundName === 'Muted') {
            setAmbient(null, btn);
          }
      
          // Loading message (기존 코드 유지)
          if (soundName === 'Muted') {
            loadingMsg.textContent = 'Sound off';
          } else {
            loadingMsg.textContent = `Loading ${soundName} sound...`;
          }
      
          loadingMsg.classList.remove('hidden');
          setTimeout(() => {
            loadingMsg.classList.add('hidden');
          }, 3000);
        });
      });
   



    const checklistKey = `goalChecklist-${session}`;

    function saveChecklistToStorage() {
      const items = [];
      document.querySelectorAll("#goalChecklist .goal-row").forEach(row => {
        const input = row.querySelector('input[type="text"]');
        const checkbox = row.querySelector('input[type="checkbox"]');
        const timeInput = row.querySelector('input[type="number"]');
        if (input && input.value.trim()) {
          items.push({ text: input.value, done: checkbox.checked, time: timeInput.value });
        }
      });
      localStorage.setItem(checklistKey, JSON.stringify(items));
    }
    
    function loadChecklistFromStorage() {
      const saved = localStorage.getItem(checklistKey);
      if (saved) {
        const container = document.getElementById("goalChecklist");
        container.innerHTML = "";
        JSON.parse(saved).forEach(item => addGoalRow(item.text, item.done, item.time));
      } else {
        addGoalRow();
      }
    }

    function addGoalRow(text = "", checked = false, time = "") {
      const container = document.getElementById("goalChecklist");
      const row = document.createElement("div");
      row.className = "goal-row";
    
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = checked;
      checkbox.onchange = () => {
        row.classList.toggle("checked", checkbox.checked);
        saveChecklistToStorage();
      };
      
      // Apply checked state immediately if loaded as checked
      if (checked) {
        row.classList.add("checked");
      }
      
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Write a small actionable item...";
      input.value = text;
      input.maxLength = 80;
      input.oninput = saveChecklistToStorage;
    
      const timeInput = document.createElement("input");
      timeInput.type = "number";
      timeInput.placeholder = "15";
      timeInput.min = 1;
      timeInput.max = 999;
      timeInput.value = time;
      timeInput.oninput = saveChecklistToStorage;
    
      const minutesLabel = document.createElement("span");
      minutesLabel.className = "minutes-label";
      minutesLabel.textContent = "min";
    
      const remove = document.createElement("button");
      remove.innerHTML = "✕";
      remove.className = "remove-goal";
      remove.onclick = () => {
        container.removeChild(row);
        saveChecklistToStorage();
      };
    
      row.appendChild(checkbox);
      row.appendChild(input);
      row.appendChild(timeInput);
      row.appendChild(minutesLabel);
      row.appendChild(remove);
    
      if (checked) row.classList.add("checked");
      container.appendChild(row);
    }

    window.addEventListener("load", loadChecklistFromStorage);

    const editable = document.getElementById("editableGoal");
    const saveBtn = document.getElementById("saveGoalBtn");
    
    function showCheckMark(el) {
      const mark = document.createElement("span");
      mark.textContent = "✔️";
      mark.style.marginLeft = "0.5rem";
      el.appendChild(mark);
      setTimeout(() => mark.remove(), 1000);
    }

    // Show save button when user starts typing
    editable.addEventListener("input", () => {
      if (editable.textContent.trim()) {
        saveBtn.style.display = "block";
        saveBtn.classList.remove("saved");
      }
    });

    // Save goal when clicking save button
    saveBtn.addEventListener("click", () => {
      let goalText = editable.textContent.trim();
      if (goalText === "") {
        saveBtn.style.display = "none";
        return;
      }
    
      saveGoal(goalText);
      saveBtn.classList.add("saved");
      showSaveToast();
      showCheckMark(editable);
      
      setTimeout(() => {
        saveBtn.style.display = "none";
        saveBtn.classList.remove("saved");
      }, 2000);
    });
    
    editable.addEventListener("focus", () => {
      if (editable.innerText.trim() === "What's one meaningful task you'll focus on?") {
        editable.innerHTML = "";
      }
    });
    
    // Auto-save when clicking outside (original behavior preserved)
    editable.addEventListener("blur", () => {
      let goalText = editable.textContent.trim();
      if (goalText === "") {
        editable.innerHTML = "";
        saveBtn.style.display = "none";
        return;
      }
      
      // Only auto-save if the save button is visible (meaning there are unsaved changes)
      if (saveBtn.style.display === "block" && !saveBtn.classList.contains("saved")) {
        saveGoal(goalText);
        showSaveToast();
        showCheckMark(editable);
        saveBtn.style.display = "none";
      }
    });
    
    function saveGoal(text) {
      if (!session || !name) return;
      
      db.collection("sessions").doc(session).collection("participants").doc(name).update({
        goal: text
      }).catch(error => {
        console.error("Error saving goal:", error);
        // Show user-friendly error message
        showErrorToast("Failed to save goal. Please try again.");
      });
    }

    const placeholderList = [
      "Finish sh**ty first draft ✍️",
      "Clean messy data 🧹",
      "Read Chapter 3 📘",
      "Fix one small bug 🐞",
      "Write intro paragraph 📝",
      "Send a status update 📤",
      "Make a doable chunk 🧩",
      "Break task into steps 🪜"
    ];

    let index = 0;

    function rotatePlaceholder() {
      const input = document.getElementById("editableGoal");
      if (input && input !== document.activeElement) {
        input.setAttribute("data-placeholder", placeholderList[index % placeholderList.length]);
        index++;
      }
    }

    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme');
        if (theme) {
          setTheme(theme);
        }
      });
    });

        // Focus blocks functions
    function labelLastBlock() {
      const input = document.getElementById('taskInput');
      const label = input.value.trim();
      
      if (label && sessionLog.length > 0) {
        for (let i = sessionLog.length - 1; i >= 0; i--) {
          if (sessionLog[i].type === 'focus' && !sessionLog[i].label) {
            sessionLog[i].label = label;
            break;
          }
        }
        input.value = '';
        saveBlocks();
        loadBlocks();
      }
    }

    function saveBlocks() {
      localStorage.setItem('pomodoro-blocks', JSON.stringify(sessionLog));
    }

    // 최신 10개만 표시하도록 수정
    function loadBlocks() {
      const saved = localStorage.getItem('pomodoro-blocks');
      if (saved) {
        sessionLog = JSON.parse(saved);
      }
      
      const logList = document.getElementById('logList');
      logList.innerHTML = '';
      
      // 최신 15개만 표시
      const focusSessions = sessionLog.filter(session => session.type === 'focus');
      const recentSessions = focusSessions.slice(-15); // 최신 15개
      
      recentSessions.forEach((session, index) => {
        const block = document.createElement('div');
        block.className = `block-item ${session.label ? '' : 'unlabeled'}`;
        
        block.innerHTML = `
          <div class="block-time">${session.time} • ${session.duration} focus session</div>
          <div class="block-label">${session.label || 'Click to add what you accomplished...'}</div>
        `;
        
        if (!session.label) {
          block.addEventListener('click', () => {
            const newLabel = prompt('What did you accomplish in this session?');
            if (newLabel && newLabel.trim()) {
              session.label = newLabel.trim();
              saveBlocks();
              loadBlocks();
            }
          });
        }
        
        logList.appendChild(block);
      });
      
      // 더 많은 세션이 있다면 표시
      if (focusSessions.length > 10) {
        const moreInfo = document.createElement('div');
        moreInfo.innerHTML = `
          <div style="text-align: center; color: #94a3b8; font-size: 0.8rem; margin-top: 1rem;">
            Showing latest 15 of ${focusSessions.length} sessions
          </div>
        `;
        logList.appendChild(moreInfo);
      }
    }

    // Rotate placeholder every 4 seconds
    setInterval(rotatePlaceholder, 4000);

    // Initial placeholder setup
    document.addEventListener("DOMContentLoaded", rotatePlaceholder);

  </script>
</body>
</html>
